<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue3 Proxyå“åº”å¼åŸç†æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .demo-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .button-group {
            margin: 10px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .performance-result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #3498db;
            color: white;
        }
        .comparison-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .vue2-col {
            background-color: #ffebee;
        }
        .vue3-col {
            background-color: #e8f5e8;
        }
        .code-block {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vue3 Proxyå“åº”å¼åŸç†æ¼”ç¤º</h1>
        
        <div class="demo-section">
            <h2>1. åŸºç¡€Proxyå“åº”å¼å®ç°</h2>
            <div class="button-group">
                <button onclick="basicProxyDemo()">è¿è¡ŒåŸºç¡€Proxyæ¼”ç¤º</button>
                <button onclick="clearOutput('basic-output')">æ¸…ç©ºè¾“å‡º</button>
            </div>
            <div id="basic-output" class="output"></div>
        </div>

        <div class="demo-section">
            <h2>2. å®Œæ•´å“åº”å¼ç³»ç»Ÿæ¼”ç¤º</h2>
            <div class="button-group">
                <button onclick="fullReactiveDemo()">è¿è¡Œå®Œæ•´å“åº”å¼æ¼”ç¤º</button>
                <button onclick="clearOutput('reactive-output')">æ¸…ç©ºè¾“å‡º</button>
            </div>
            <div id="reactive-output" class="output"></div>
        </div>

        <div class="demo-section">
            <h2>3. æ•°ç»„å“åº”å¼æ¼”ç¤º</h2>
            <div class="button-group">
                <button onclick="arrayReactiveDemo()">è¿è¡Œæ•°ç»„å“åº”å¼æ¼”ç¤º</button>
                <button onclick="clearOutput('array-output')">æ¸…ç©ºè¾“å‡º</button>
            </div>
            <div id="array-output" class="output"></div>
        </div>

        <div class="demo-section">
            <h2>4. æ€§èƒ½å¯¹æ¯”æ¼”ç¤º</h2>
            <div class="button-group">
                <button onclick="performanceComparison()">è¿è¡Œæ€§èƒ½å¯¹æ¯”</button>
                <button onclick="clearOutput('performance-output')">æ¸…ç©ºè¾“å‡º</button>
            </div>
            <div id="performance-output" class="output"></div>
            <div id="performance-result" class="performance-result" style="display: none;"></div>
        </div>

        <div class="demo-section">
            <h2>5. Vue2 vs Vue3 åŠŸèƒ½å¯¹æ¯”</h2>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>åŠŸèƒ½ç‰¹æ€§</th>
                        <th class="vue2-col">Vue2 (Object.defineProperty)</th>
                        <th class="vue3-col">Vue3 (Proxy)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>å±æ€§æ·»åŠ æ£€æµ‹</td>
                        <td class="vue2-col">âŒ éœ€è¦Vue.set</td>
                        <td class="vue3-col">âœ… åŸç”Ÿæ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>å±æ€§åˆ é™¤æ£€æµ‹</td>
                        <td class="vue2-col">âŒ éœ€è¦Vue.delete</td>
                        <td class="vue3-col">âœ… åŸç”Ÿæ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>æ•°ç»„ç´¢å¼•ä¿®æ”¹</td>
                        <td class="vue2-col">âŒ æ— æ³•æ£€æµ‹</td>
                        <td class="vue3-col">âœ… å®Œå…¨æ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>æ•°ç»„é•¿åº¦ä¿®æ”¹</td>
                        <td class="vue2-col">âŒ æ— æ³•æ£€æµ‹</td>
                        <td class="vue3-col">âœ… å®Œå…¨æ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>Map/Setæ”¯æŒ</td>
                        <td class="vue2-col">âŒ ä¸æ”¯æŒ</td>
                        <td class="vue3-col">âœ… å®Œå…¨æ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>åˆå§‹åŒ–æ€§èƒ½</td>
                        <td class="vue2-col">âŒ éœ€è¦é€’å½’éå†</td>
                        <td class="vue3-col">âœ… æƒ°æ€§å¤„ç†</td>
                    </tr>
                    <tr>
                        <td>å†…å­˜å ç”¨</td>
                        <td class="vue2-col">âŒ æ¯ä¸ªå±æ€§éƒ½æœ‰é—­åŒ…</td>
                        <td class="vue3-col">âœ… æ›´å°‘çš„å†…å­˜å ç”¨</td>
                    </tr>
                    <tr>
                        <td>æµè§ˆå™¨å…¼å®¹æ€§</td>
                        <td class="vue2-col">âœ… IE9+</td>
                        <td class="vue3-col">âŒ IEä¸æ”¯æŒ</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="demo-section">
            <h2>6. æ ¸å¿ƒä»£ç å®ç°</h2>
            <h3>Vue3 Proxyå“åº”å¼æ ¸å¿ƒä»£ç ï¼š</h3>
            <div class="code-block">
// å…¨å±€ä¾èµ–æ˜ å°„
const targetMap = new WeakMap();
let activeEffect = null;

// ä¾èµ–æ”¶é›†
function track(target, key) {
  if (!activeEffect) return;
  
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()));
  }
  
  let dep = depsMap.get(key);
  if (!dep) {
    depsMap.set(key, (dep = new Set()));
  }
  
  dep.add(activeEffect);
}

// è§¦å‘æ›´æ–°
function trigger(target, key) {
  const depsMap = targetMap.get(target);
  if (!depsMap) return;
  
  const dep = depsMap.get(key);
  if (dep) {
    dep.forEach(effect => {
      if (effect !== activeEffect) {
        effect();
      }
    });
  }
}

// åˆ›å»ºå“åº”å¼å¯¹è±¡
function reactive(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      track(target, key);
      const result = Reflect.get(target, key, receiver);
      return typeof result === 'object' && result !== null 
        ? reactive(result) 
        : result;
    },
    set(target, key, value, receiver) {
      const result = Reflect.set(target, key, value, receiver);
      trigger(target, key);
      return result;
    }
  });
}

// å‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  const effectFn = () => {
    try {
      activeEffect = effectFn;
      return fn();
    } finally {
      activeEffect = null;
    }
  };
  effectFn();
  return effectFn;
}
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€ä¾èµ–æ˜ å°„
        const targetMap = new WeakMap();
        let activeEffect = null;

        // ä¾èµ–æ”¶é›†
        function track(target, key) {
            if (!activeEffect) return;
            
            let depsMap = targetMap.get(target);
            if (!depsMap) {
                targetMap.set(target, (depsMap = new Map()));
            }
            
            let dep = depsMap.get(key);
            if (!dep) {
                depsMap.set(key, (dep = new Set()));
            }
            
            dep.add(activeEffect);
            log(`ğŸ“¦ æ”¶é›†ä¾èµ–: ${key}`);
        }

        // è§¦å‘æ›´æ–°
        function trigger(target, key) {
            const depsMap = targetMap.get(target);
            if (!depsMap) return;
            
            const dep = depsMap.get(key);
            if (dep) {
                log(`ğŸš€ è§¦å‘æ›´æ–°: ${key}`);
                dep.forEach(effect => {
                    if (effect !== activeEffect) {
                        effect();
                    }
                });
            }
        }

        // åˆ›å»ºå“åº”å¼å¯¹è±¡
        function reactive(target) {
            if (typeof target !== 'object' || target === null) {
                return target;
            }
            
            return new Proxy(target, {
                get(target, key, receiver) {
                    log(`ğŸ” è®¿é—®å±æ€§: ${key}`);
                    track(target, key);
                    const result = Reflect.get(target, key, receiver);
                    
                    // æ·±å±‚å“åº”å¼
                    if (typeof result === 'object' && result !== null) {
                        return reactive(result);
                    }
                    
                    return result;
                },
                
                set(target, key, value, receiver) {
                    const oldValue = target[key];
                    log(`âœï¸ è®¾ç½®å±æ€§: ${key} = ${JSON.stringify(value)}`);
                    const result = Reflect.set(target, key, value, receiver);
                    
                    if (oldValue !== value) {
                        trigger(target, key);
                    }
                    
                    return result;
                },
                
                has(target, key) {
                    log(`â“ æ£€æŸ¥å±æ€§: ${key}`);
                    track(target, key);
                    return Reflect.has(target, key);
                },
                
                deleteProperty(target, key) {
                    log(`ğŸ—‘ï¸ åˆ é™¤å±æ€§: ${key}`);
                    const hadKey = Object.prototype.hasOwnProperty.call(target, key);
                    const result = Reflect.deleteProperty(target, key);
                    
                    if (result && hadKey) {
                        trigger(target, key);
                    }
                    
                    return result;
                }
            });
        }

        // å‰¯ä½œç”¨å‡½æ•°
        function effect(fn, name = 'effect') {
            const effectFn = () => {
                try {
                    activeEffect = effectFn;
                    log(`ğŸ¯ æ‰§è¡Œå‰¯ä½œç”¨: ${name}`);
                    return fn();
                } finally {
                    activeEffect = null;
                }
            };
            
            effectFn.effectName = name;
            effectFn();
            return effectFn;
        }

        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        let currentOutputId = '';
        function log(message) {
            if (currentOutputId) {
                const output = document.getElementById(currentOutputId);
                if (output) {
                    output.innerHTML += message + '\n';
                    output.scrollTop = output.scrollHeight;
                }
            }
        }

        function clearOutput(outputId) {
            document.getElementById(outputId).innerHTML = '';
        }

        // æ¼”ç¤ºå‡½æ•°
        function basicProxyDemo() {
            currentOutputId = 'basic-output';
            clearOutput(currentOutputId);
            
            log('=== åŸºç¡€Proxyå“åº”å¼æ¼”ç¤º ===\n');
            
            // åˆ›å»ºå“åº”å¼å¯¹è±¡
            const state = reactive({
                message: 'Hello Vue3!',
                count: 0
            });
            
            // åˆ›å»ºå‰¯ä½œç”¨å‡½æ•°
            effect(() => {
                log(`ğŸ“º æ¸²æŸ“: ${state.message}, è®¡æ•°: ${state.count}`);
            }, 'æ¸²æŸ“å‡½æ•°');
            
            log('\n--- å¼€å§‹ä¿®æ”¹æ•°æ® ---');
            
            // ä¿®æ”¹æ•°æ®
            setTimeout(() => {
                state.message = 'Hello Proxy!';
            }, 1000);
            
            setTimeout(() => {
                state.count = 1;
            }, 2000);
            
            setTimeout(() => {
                state.newProp = 'æ–°å±æ€§';
            }, 3000);
        }

        function fullReactiveDemo() {
            currentOutputId = 'reactive-output';
            clearOutput(currentOutputId);
            
            log('=== å®Œæ•´å“åº”å¼ç³»ç»Ÿæ¼”ç¤º ===\n');
            
            const state = reactive({
                user: {
                    name: 'John',
                    age: 25,
                    profile: {
                        email: 'john@example.com'
                    }
                },
                settings: {
                    theme: 'light'
                }
            });
            
            // å¤šä¸ªå‰¯ä½œç”¨å‡½æ•°
            effect(() => {
                log(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${state.user.name} (${state.user.age}å²)`);
            }, 'ç”¨æˆ·ä¿¡æ¯æ¸²æŸ“');
            
            effect(() => {
                log(`âš™ï¸ è®¾ç½®: ä¸»é¢˜=${state.settings.theme}`);
            }, 'è®¾ç½®æ¸²æŸ“');
            
            effect(() => {
                if (state.user.profile) {
                    log(`ğŸ“§ é‚®ç®±: ${state.user.profile.email}`);
                }
            }, 'é‚®ç®±æ¸²æŸ“');
            
            log('\n--- å¼€å§‹ä¿®æ”¹æ·±å±‚æ•°æ® ---');
            
            setTimeout(() => {
                state.user.name = 'Jane';
            }, 1000);
            
            setTimeout(() => {
                state.user.profile.email = 'jane@example.com';
            }, 2000);
            
            setTimeout(() => {
                state.settings.theme = 'dark';
            }, 3000);
            
            setTimeout(() => {
                delete state.user.age;
            }, 4000);
        }

        function arrayReactiveDemo() {
            currentOutputId = 'array-output';
            clearOutput(currentOutputId);
            
            log('=== æ•°ç»„å“åº”å¼æ¼”ç¤º ===\n');
            
            const state = reactive({
                items: [1, 2, 3],
                users: [
                    { name: 'Alice', age: 20 },
                    { name: 'Bob', age: 25 }
                ]
            });
            
            effect(() => {
                log(`ğŸ“‹ æ•°ç»„é¡¹: [${state.items.join(', ')}] (é•¿åº¦: ${state.items.length})`);
            }, 'æ•°ç»„æ¸²æŸ“');
            
            effect(() => {
                log(`ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨: ${state.users.map(u => u.name).join(', ')}`);
            }, 'ç”¨æˆ·åˆ—è¡¨æ¸²æŸ“');
            
            log('\n--- å¼€å§‹æ•°ç»„æ“ä½œ ---');
            
            setTimeout(() => {
                log('\nğŸ”§ æ‰§è¡Œ push(4)');
                state.items.push(4);
            }, 1000);
            
            setTimeout(() => {
                log('\nğŸ”§ æ‰§è¡Œ items[0] = 10');
                state.items[0] = 10;
            }, 2000);
            
            setTimeout(() => {
                log('\nğŸ”§ æ‰§è¡Œ length = 2');
                state.items.length = 2;
            }, 3000);
            
            setTimeout(() => {
                log('\nğŸ”§ æ·»åŠ æ–°ç”¨æˆ·');
                state.users.push({ name: 'Charlie', age: 30 });
            }, 4000);
            
            setTimeout(() => {
                log('\nğŸ”§ ä¿®æ”¹ç”¨æˆ·å');
                state.users[0].name = 'Alice Smith';
            }, 5000);
        }

        function performanceComparison() {
            currentOutputId = 'performance-output';
            clearOutput(currentOutputId);
            
            log('=== æ€§èƒ½å¯¹æ¯”æ¼”ç¤º ===\n');
            
            // åˆ›å»ºå¤§å¯¹è±¡è¿›è¡Œæµ‹è¯•
            const createLargeObject = (size) => {
                const obj = {};
                for (let i = 0; i < size; i++) {
                    obj[`prop${i}`] = {
                        value: i,
                        nested: {
                            deep: `value${i}`
                        }
                    };
                }
                return obj;
            };
            
            const sizes = [100, 500, 1000];
            const results = [];
            
            sizes.forEach(size => {
                log(`\nğŸ“Š æµ‹è¯•å¯¹è±¡å¤§å°: ${size} ä¸ªå±æ€§`);
                
                // æ¨¡æ‹ŸVue2çš„åˆå§‹åŒ–ï¼ˆé€’å½’éå†æ‰€æœ‰å±æ€§ï¼‰
                const vue2Start = performance.now();
                const vue2Obj = createLargeObject(size);
                // æ¨¡æ‹ŸObject.definePropertyçš„é€’å½’å¤„ç†
                function mockVue2Reactive(obj) {
                    Object.keys(obj).forEach(key => {
                        if (typeof obj[key] === 'object' && obj[key] !== null) {
                            mockVue2Reactive(obj[key]);
                        }
                    });
                }
                mockVue2Reactive(vue2Obj);
                const vue2Time = performance.now() - vue2Start;
                
                // Vue3çš„åˆå§‹åŒ–ï¼ˆåªåˆ›å»ºProxyï¼‰
                const vue3Start = performance.now();
                const vue3Obj = reactive(createLargeObject(size));
                const vue3Time = performance.now() - vue3Start;
                
                log(`Vue2æ¨¡æ‹Ÿåˆå§‹åŒ–æ—¶é—´: ${vue2Time.toFixed(2)}ms`);
                log(`Vue3 Proxyåˆå§‹åŒ–æ—¶é—´: ${vue3Time.toFixed(2)}ms`);
                log(`æ€§èƒ½æå‡: ${((vue2Time - vue3Time) / vue2Time * 100).toFixed(1)}%`);
                
                results.push({
                    size,
                    vue2Time: vue2Time.toFixed(2),
                    vue3Time: vue3Time.toFixed(2),
                    improvement: ((vue2Time - vue3Time) / vue2Time * 100).toFixed(1)
                });
            });
            
            // æ˜¾ç¤ºç»“æœè¡¨æ ¼
            const resultDiv = document.getElementById('performance-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>æ€§èƒ½æµ‹è¯•ç»“æœ</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="background: #f0f0f0;">
                        <th style="border: 1px solid #ddd; padding: 8px;">å¯¹è±¡å¤§å°</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Vue2æ¨¡æ‹Ÿæ—¶é—´</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Vue3æ—¶é—´</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">æ€§èƒ½æå‡</th>
                    </tr>
                    ${results.map(r => `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${r.size} ä¸ªå±æ€§</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${r.vue2Time}ms</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${r.vue3Time}ms</td>
                            <td style="border: 1px solid #ddd; padding: 8px; color: green;">${r.improvement}%</td>
                        </tr>
                    `).join('')}
                </table>
                <p><strong>ç»“è®ºï¼š</strong>Vue3çš„Proxyåœ¨åˆå§‹åŒ–é˜¶æ®µæœ‰æ˜¾è‘—çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤§å‹å¯¹è±¡ã€‚</p>
            `;
        }
    </script>
</body>
</html>